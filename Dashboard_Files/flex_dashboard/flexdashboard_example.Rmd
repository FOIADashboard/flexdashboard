---
title: "FOIA dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    #source_code: embed
    theme:
      version: 4
      bootswatch: lux
---

```{r global}
library(flexdashboard)
library(shiny)
library(knitr)
library(kableExtra)
library(dplyr)
library(ggplot2)
library(plotly)
library(tidyr)
library(ggplot2)
library(stringr)

# global variables
rda_dir <- "data/rda"
csv_dir <- "data/csv"
agencies <- c("DHS", "EPA", "DOL", "DOJ", "DOS", "HHS")
component_list <- list(
  "DHS" = c("CBP", "PRIV", "USCIS", "ICE", "OIG", "CRCL"),
  "EPA" = c("HQ", "Region 1", "Region 2", "Region 3",
            "Region 4", "Region 5", "Region 6", "Region 7",
            "Region 8", "Region 9", "Region 10"),
  "DOL" = c("OSHA", "WHD", "OSEC", "OIG"),
  "DOJ" = c("EOIR", "OIG"),
  "HHS" = c("CDC", "ACF", "OIG"),
  "DOS" = c("OIG", "DoS")
)

# load functions used in script
source("functions.R")
source("ui_functions.R")

```

Personnel/Cost
=====================================

Inputs {.sidebar}
-----------------------------------

```{r}
# define variables for section
# update the IDs, change the list variable name, 
# then replace the variables with ctrl + f
personnel_data_list <- list(
  agency_id = "PersonnelAgency",
  component_id = "PersonnelComponent",
  fy_id = "PersonnelFY",
  column_id = "PersonnelData"
)

# column select UI. Update the variable name
personnel_column_select_ui <- selectInput(
  personnel_data_list$column_id,
  "Data",
  choices = c(
    "Full Time" = "FullTimeEmployeeQuantity",
    "Equivalent Full Time" = "EquivalentFullTimeEmployeeQuantity",
    "Total Full Time Staff" = "TotalFullTimeStaffQuantity",
    "Processing Expenditure" = "ProcessingCostAmount",
    "Litigation Cost" = "LitigationCostAmount",
    "Total Cost" = "TotalCostAmount"
  ),
  selected = "TotalFullTimeStaffQuantity"
)

# create UI. Update the variables
ui_function(
  section_agency_id = personnel_data_list$agency_id, 
  section_component_id = personnel_data_list$component_id, 
  section_fy_id = personnel_data_list$fy_id, 
  custom_column_select_ui = personnel_column_select_ui)
```

Row {data-height=300}
-------------------------------------

###

```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
personnel_input_values <- reactiveValues()
observe({
  personnel_input_values$agency <- input[[personnel_data_list$agency_id]]
  personnel_input_values$component <- input[[personnel_data_list$component_id]]
  personnel_input_values$fy <- input[[personnel_data_list$fy_id]]
  personnel_input_values$data <- input[[personnel_data_list$column_id]]
  personnel_input_values$component_input_id <- personnel_data_list$component_id
})

# Update filtered data variable name
personnel_filtered_data <- reactive({
  req(personnel_input_values$agency)
  load_foia(
    input_data = personnel_input_values$agency,
    possible_agencies = agencies,
    section_name = "PersonnelAndCostSection",
    data_dir = rda_dir
  )
})

observe({
  req(personnel_input_values$agency)
  updateCheckboxGroupInput(
    session, personnel_input_values$component_input_id, "Component",
    choices = component_list[[personnel_input_values$agency]],
    selected = component_list[[personnel_input_values$agency]][c(1,2)]
  )
})

# Maps the column name to the plot title
filtered_input_manual_title <- reactive({
  if (personnel_input_values$data == "FullTimeEmployeeQuantity") {
    return("Full Time Employees")
  } else if (personnel_input_values$data == "EquivalentFullTimeEmployeeQuantity") {
    return("Equivalent Full Time Employees")
  } else if (personnel_input_values$data == "TotalFullTimeStaffQuantity") {
    return("Total Full Time Staff")
  } else if (personnel_input_values$data == "ProcessingCostAmount") {
    return("Processing Expenditures")
  } else if (personnel_input_values$data == "LitigationCostAmount") {
    return("Litigation Costs")
  } else if (personnel_input_values$data == "TotalCostAmount") {
    return("Total Costs")
  } else {
    return(NULL) # Return NULL if no match is found
  }
})

renderPlotly({
  plot_single_column(
    isolate(personnel_filtered_data()),
    personnel_input_values$data,
    personnel_input_values$component,
    personnel_input_values$fy,
    manual_title = filtered_input_manual_title()
  )
})
```

Backlog
=====================================
  
Inputs {.sidebar}
-----------------------------------
  
```{r}
# define variables for section
# update the IDs, change the list variable name, 
# then replace the variables with ctrl + f
backlog_data_list <- list(
  agency_id = "BacklogAgency",
  component_id = "BacklogComponent",
  fy_id = "BacklogFY",
  column_id = "BacklogData"
)

# column select UI. Update the variable name
backlog_column_select_ui <- selectInput(
  backlog_data_list$column_id, "Data", 
  choices = c("Backlogged Requests" = "BackloggedRequestQuantity"), 
  selected = "BackloggedRequestQuantity")

# create UI. Update the variables
ui_function(
  section_agency_id = backlog_data_list$agency_id, 
  section_component_id = backlog_data_list$component_id, 
  section_fy_id = backlog_data_list$fy_id, 
  custom_column_select_ui = backlog_column_select_ui)
```

Row {data-height=300}
-------------------------------------
  
###
  
```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
backlog_input_values <- reactiveValues()
observe({
  backlog_input_values$agency <- input[[backlog_data_list$agency_id]]
  backlog_input_values$component <- input[[backlog_data_list$component_id]]
  backlog_input_values$fy <- input[[backlog_data_list$fy_id]]
  backlog_input_values$data <- input[[backlog_data_list$column_id]]
  backlog_input_values$component_input_id <- backlog_data_list$component_id
})

# Update filtered data variable name
backlog_filtered_data <- reactive({
  req(backlog_input_values$agency)
  load_foia(
    input_data = backlog_input_values$agency,
    possible_agencies = agencies,
    section_name = "BacklogSection",
    data_dir = rda_dir
  )
})

observe({
  req(backlog_input_values$agency)
  updateCheckboxGroupInput(
    session, backlog_input_values$component_input_id, "Component",
    choices = component_list[[backlog_input_values$agency]],
    selected = component_list[[backlog_input_values$agency]][c(1,2)]
  )
})

renderPlotly({
  plot_single_column(
    isolate(backlog_filtered_data()),
    backlog_input_values$data,
    backlog_input_values$component,
    backlog_input_values$fy,
    manual_title = "Backlogged Requests"
  )
})
```


Expedited Processing
=====================================

Inputs {.sidebar}
-------------------------------------

```{r}
# define variables for section
# update the IDs, change the list variable name, 
# then replace the variables with ctrl + f
expedited_data_list <- list(
  agency_id = "ExpeditedAgency",
  component_id = "ExpeditedComponent",
  fy_id = "ExpeditedFY",
  column_id = "ExpeditedData"
)

# column select UI. Update the variable name
expedited_column_select_ui <- selectInput(
  expedited_data_list$column_id, "Data", 
  choices = c("Requests Granted" = "RequestGrantedQuantity",
              "Requests Denied" = "RequestDeniedQuantity",
              "Adjudication Median" = "AdjudicationMedianDaysValue",
              "Adjudication Avg. Days" = "AdjudicationAverageDaysValue",
              "Within Ten Days" = "AdjudicationWithinTenDaysQuantity"), 
  selected = "AdjudicationWithinTenDaysQuantity")

# create UI. Update the variables
ui_function(
  section_agency_id = expedited_data_list$agency_id, 
  section_component_id = expedited_data_list$component_id, 
  section_fy_id = expedited_data_list$fy_id, 
  custom_column_select_ui = expedited_column_select_ui)
```

Row {data-height=300}
-------------------------------------

###

```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
expedited_input_values <- reactiveValues()
observe({
  expedited_input_values$agency <- input[[expedited_data_list$agency_id]]
  expedited_input_values$component <- input[[expedited_data_list$component_id]]
  expedited_input_values$fy <- input[[expedited_data_list$fy_id]]
  expedited_input_values$data <- input[[expedited_data_list$column_id]]
  expedited_input_values$component_input_id <- expedited_data_list$component_id
})

# Update filtered data variable name
expedited_filtered_data <- reactive({
  req(expedited_input_values$agency)
  load_foia(
    input_data = expedited_input_values$agency,
    possible_agencies = agencies,
    section_name = "ExpeditedProcessingSection",
    data_dir = rda_dir
  )
})

observe({
  req(expedited_input_values$agency)
  updateCheckboxGroupInput(
    session, expedited_input_values$component_input_id, "Component",
    choices = component_list[[expedited_input_values$agency]],
    selected = component_list[[expedited_input_values$agency]][c(1,2)]
  )
})

# Maps the column name to the plot title
filtered_input_manual_title_expedited <- reactive({
  if (expedited_input_values$data == "RequestGrantedQuantity") {
    return("Adjudication Requests Granted")
  } else if (expedited_input_values$data == "RequestDeniedQuantity") {
    return("Adjudication Requests Denied")
  } else if (expedited_input_values$data == "AdjudicationMedianDaysValue") {
    return("Median Adjudication (Days)")
  } else if (expedited_input_values$data == "AdjudicationAverageDaysValue") {
    return("Average Adjudication (Days)")
  } else if (expedited_input_values$data == "AdjudicationWithinTenDaysQuantity") {
    return("Requests Adjudicated Within Ten Days")
  } else {
    return(NULL)  # Return NULL if no match is found
  }
})

renderPlotly({
  plot_single_column(
    isolate(expedited_filtered_data()),
    expedited_input_values$data,
    expedited_input_values$component,
    expedited_input_values$fy,
    manual_title = filtered_input_manual_title_expedited()
  )
})
```

Processed Requests
=====================================

Inputs {.sidebar}
-------------------------------------

```{r}
# define variables for section
# update the IDs, change the list variable name, 
# then replace the variables with ctrl + f
PR_data_list <- list(
  agency_id = "PRAgency",
  component_id = "PRComponent",
  fy_id = "PRFY",
  column_id = "PRData"
)

# column select UI. Update the variable name
PR_column_select_ui <- selectInput(
  PR_data_list$column_id, "Data", 
  choices = c("Pending FY Start" = "ProcessingStatisticsPendingAtStartQuantity", 
              "Pending FY End" = "ProcessingStatisticsPendingAtEndQuantity", 
              "Requests Received" = "ProcessingStatisticsReceivedQuantity", 
              "Requests Processed" = "ProcessingStatisticsProcessedQuantity"), 
  selected = "ProcessingStatisticsPendingAtStartQuantity")

# create UI. Update the variables
ui_function(
  section_agency_id = PR_data_list$agency_id, 
  section_component_id = PR_data_list$component_id, 
  section_fy_id = PR_data_list$fy_id, 
  custom_column_select_ui = PR_column_select_ui)
```

Row {data-height=300}
-------------------------------------

###

```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
pr_input_values <- reactiveValues()
observe({
  pr_input_values$agency <- input[[PR_data_list$agency_id]]
  pr_input_values$component <- input[[PR_data_list$component_id]]
  pr_input_values$fy <- input[[PR_data_list$fy_id]]
  pr_input_values$data <- input[[PR_data_list$column_id]]
  pr_input_values$component_input_id <- PR_data_list$component_id
})

# Update filtered data variable name
PR_filtered_data <- reactive({
  req(pr_input_values$agency)
  load_foia(
    input_data = pr_input_values$agency,
    possible_agencies = agencies,
    section_name = "ProcessedRequestSection",
    data_dir = rda_dir
  )
})

observe({
  req(pr_input_values$agency)
  updateCheckboxGroupInput(
    session, pr_input_values$component_input_id, "Component",
    choices = component_list[[pr_input_values$agency]],
    selected = component_list[[pr_input_values$agency]][c(1,2)]
  )
})

# Maps the column name to the plot title
filtered_input_manual_title_PR <- reactive({
  if (pr_input_values$data == "ProcessingStatisticsPendingAtStartQuantity") {
    return("Requests Pending at FY Start")
  } else if (pr_input_values$data == "ProcessingStatisticsPendingAtEndQuantity") {
    return("Requests Pending at FY End")
  } else if (pr_input_values$data == "ProcessingStatisticsReceivedQuantity") {
    return("Requests Received")
  } else if (pr_input_values$data == "ProcessingStatisticsProcessedQuantity") {
    return("Requests Processed")
  } else {
    return(NULL)  # Return NULL if no match is found
  }
})

renderPlotly({
  plot_single_column(
    isolate(PR_filtered_data()),
    pr_input_values$data,
    pr_input_values$component,
    pr_input_values$fy,
    manual_title = filtered_input_manual_title_PR()
  )
})
```


Pending Requests
=====================================

Inputs {.sidebar}
-------------------------------------

```{r}
# define variables for section
# update the IDs, change the list variable name, 
# then replace the variables with ctrl + f
pendingR_data_list <- list(
  agency_id = "PendingRAgency",
  component_id = "PendingRComponent",
  fy_id = "PendingRFY",
  column_id = "PendingRData"
)

# column select UI. Update the variable name
pendingR_column_select_ui <- selectInput(
  pendingR_data_list$column_id, "Statistic", 
  choices = c("Simple Pending Requests" = "SimplePendingRequestStatisticsPendingRequestQuantity",
              "Simple Median Days" = "SimplePendingRequestStatisticsPendingRequestMedianDaysValue",
              "Simple Average Days" ="SimplePendingRequestStatisticsPendingRequestAverageDaysValue",
              "Complex Pending Requests" = "ComplexPendingRequestStatisticsPendingRequestQuantity",
              "Complex Median Days" = "ComplexPendingRequestStatisticsPendingRequestMedianDaysValue",
              "Complex Average Days" = "ComplexPendingRequestStatisticsPendingRequestAverageDaysValue",
              "Expedited Pending Requests" = "ExpeditedPendingRequestStatisticsPendingRequestQuantity",
              "Expedited Median Days" = "ExpeditedPendingRequestStatisticsPendingRequestMedianDaysValue",
              "Expedited Average Days" = "ExpeditedPendingRequestStatisticsPendingRequestAverageDaysValue"), 
  selected = "Simple Pending Requests")

# create UI. Update the variables
ui_function(
  section_agency_id = pendingR_data_list$agency_id, 
  section_component_id = pendingR_data_list$component_id, 
  section_fy_id = pendingR_data_list$fy_id, 
  custom_column_select_ui = pendingR_column_select_ui)
```

Row {data-height=300}
-------------------------------------

###

```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
pendingR_input_values <- reactiveValues()
observe({
  pendingR_input_values$agency <- input[[pendingR_data_list$agency_id]]
  pendingR_input_values$component <- input[[pendingR_data_list$component_id]]
  pendingR_input_values$fy <- input[[pendingR_data_list$fy_id]]
  pendingR_input_values$data <- input[[pendingR_data_list$column_id]]
  pendingR_input_values$component_input_id <- pendingR_data_list$component_id
})

# Update filtered data variable name
pendingR_filtered_data <- reactive({
  req(pendingR_input_values$agency)
  load_foia(
    input_data = pendingR_input_values$agency,
    possible_agencies = agencies,
    section_name = "PendingPerfectedRequestsSection",
    data_dir = rda_dir,
    ppr = TRUE
  )
})

observe({
  req(pendingR_input_values$agency)
  updateCheckboxGroupInput(
    session, pendingR_input_values$component_input_id, "Component",
    choices = component_list[[pendingR_input_values$agency]],
    selected = component_list[[pendingR_input_values$agency]][c(1,2)]
  )
})

# Maps the column name to the plot title
filtered_input_manual_title_pendingR <- reactive({
  if (pendingR_input_values$data == "SimplePendingRequestStatisticsPendingRequestQuantity") {
    return("Simple Pending Request Quantity")
  } else if (pendingR_input_values$data == "SimplePendingRequestStatisticsPendingRequestMedianDaysValue") {
    return("Simple Pending Request Median Days")
  } else if (pendingR_input_values$data == "SimplePendingRequestStatisticsPendingRequestAverageDaysValue") {
    return("Simple Pending Request Average Days")
  } else if (pendingR_input_values$data == "ComplexPendingRequestStatisticsPendingRequestQuantity") {
    return("Complex Pending Request Quantity")
  } else if (pendingR_input_values$data == "ComplexPendingRequestStatisticsPendingRequestMedianDaysValue") {
    return("Complex Pending Request Median Days")
  } else if (pendingR_input_values$data == "ComplexPendingRequestStatisticsPendingRequestAverageDaysValue") {
    return("Complex Pending Request Average Days")
  } else if (pendingR_input_values$data == "ExpeditedPendingRequestStatisticsPendingRequestQuantity") {
    return("Expedited Pending Request Quantity")
  } else if (pendingR_input_values$data == "ExpeditedPendingRequestStatisticsPendingRequestMedianDaysValue") {
    return("Expedited Pending Request Median Days")
  } else if (pendingR_input_values$data == "ExpeditedPendingRequestStatisticsPendingRequestAverageDaysValue") {
    return("Expedited Pending Request Average Days")
  } else {
    return(NULL)  # Return NULL if no match is found
  }
})

renderPlotly({
  plot_single_column(
    isolate(pendingR_filtered_data()),
    pendingR_input_values$data,
    pendingR_input_values$component,
    pendingR_input_values$fy,
    manual_title = filtered_input_manual_title_pendingR()
  )
})
```

Appeal Disposition
=====================================

Inputs {.sidebar}
-------------------------------------

```{r}
# define variables for section
# update the IDs, change the list variable name, 
# then replace the variables with ctrl + f
appealDisp_data_list <- list(
  agency_id = "appealDispAgency",
  component_id = "appealDispComponent",
  fy_id = "appealDispFY",
  column_id = "appealDispData"
)

# column select UI. Update the variable name
appealDisp_column_select_ui <- selectInput(
  appealDisp_data_list$column_id, "Statistic", 
  choices = c("Affirmed On Appeal" = "AppealDispositionAffirmedQuantity",
              "Partially Affirmed On Appeal" = "AppealDispositionPartialQuantity",
              "Reversed On Appeal" = "AppealDispositionReversedQuantity",
              "Appeal Closed - Other" = "AppealDispositionOtherQuantity",
              "Number of Appeals" = "AppealDispositionTotalQuantity"), 
  selected = "AppealDispositionTotalQuantity")

# create UI. Update the variables
ui_function(
  section_agency_id = appealDisp_data_list$agency_id, 
  section_component_id = appealDisp_data_list$component_id, 
  section_fy_id = appealDisp_data_list$fy_id, 
  custom_column_select_ui = appealDisp_column_select_ui,
  agencies = c("DHS", "EPA", "DOL", "DOS")
)
```

Row {data-height=300}
-------------------------------------

###

```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
appealDisp_input_values <- reactiveValues()
observe({
  appealDisp_input_values$agency <- input[[appealDisp_data_list$agency_id]]
  appealDisp_input_values$component <- input[[appealDisp_data_list$component_id]]
  appealDisp_input_values$fy <- input[[appealDisp_data_list$fy_id]]
  appealDisp_input_values$data <- input[[appealDisp_data_list$column_id]]
  appealDisp_input_values$component_input_id <- appealDisp_data_list$component_id
})

# Update filtered data variable name
appealDisp_filtered_data <- reactive({
  req(appealDisp_input_values$agency)
  load_foia(
    input_data = appealDisp_input_values$agency,
    possible_agencies = agencies,
    section_name = "AppealDispositionSection",
    data_dir = rda_dir
  )
})

observe({
  req(appealDisp_input_values$agency)
  updateCheckboxGroupInput(
    session, appealDisp_input_values$component_input_id, "Component",
    choices = component_list[[appealDisp_input_values$agency]],
    selected = component_list[[appealDisp_input_values$agency]][c(1,2)]
  )
})

filtered_input_manual_title_appeal_dis <- reactive({
  if (appealDisp_input_values$data == "AppealDispositionAffirmedQuantity") {
    return("Affirmed on Appeal")
  } else if (appealDisp_input_values$data == "AppealDispositionPartialQuantity") {
    return("Partially Affirmed on Appeal")
  } else if (appealDisp_input_values$data == "AppealDispositionReversedQuantity") {
    return("Reversed on Appeal")
  } else if (appealDisp_input_values$data == "AppealDispositionOtherQuantity") {
    return("Appeals Closed for Other Reasons")
  } else if (appealDisp_input_values$data == "AppealDispositionTotalQuantity") {
    return("Number of Appeals")
  } else {
    return(NULL)  # Return NULL if no match is found
  }
})

renderPlotly({
  plot_single_column(
    isolate(appealDisp_filtered_data()),
    appealDisp_input_values$data,
    appealDisp_input_values$component,
    appealDisp_input_values$fy,
    manual_title = filtered_input_manual_title_appeal_dis()
  )
})
```

Agency Budgets
=====================================

Inputs {.sidebar}
-------------------------------------

```{r}
# define variables for section
# update the IDs, change the list variable name,
# then replace the variables with ctrl + f
agencyBudgets_data_list <- list(
  agency_id = "budgetAgency",
  component_id = "budgetComponent",
  fy_id = "budgetFY",
  column_id = "budget_column_id"
)

# column select UI. Update the variable name
agencyBudgets_column_select_ui <- NULL

# provide custom ui for component selection
agencyBudgets_component_select_ui <- selectInput(
  agencyBudgets_data_list$component_id,
  "Component",
  choices = c("CBP", "PRIV", "USCIS", "ICE", "OIG", "CRCL"), 
  selected = "CBP"
)

# create UI. Update the variables
ui_function(
  section_agency_id = agencyBudgets_data_list$agency_id,
  section_component_id = agencyBudgets_data_list$component_id,
  section_fy_id = agencyBudgets_data_list$fy_id,
  custom_column_select_ui = agencyBudgets_column_select_ui,
  agencies = c("DHS", "DOJ", "HHS", "DOS", "DOL"),
  component_select_ui = agencyBudgets_component_select_ui
)
```

Row {data-height=400}
-------------------------------------

###

```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
agencyBudget_input_values <- reactiveValues()

observe({
  agencyBudget_input_values$agency <- input[[agencyBudgets_data_list$agency_id]]
  agencyBudget_input_values$component <- input[[agencyBudgets_data_list$component_id]]
  agencyBudget_input_values$fy <- input[[agencyBudgets_data_list$fy_id]]
  agencyBudget_input_values$data <- input[[agencyBudgets_data_list$column_id]]
  agencyBudget_input_values$component_input_id <- agencyBudgets_data_list$component_id
})

# update component selection
observe({
  req(agencyBudget_input_values$agency)
  updateSelectInput(
    session, agencyBudget_input_values$component_input_id, "Component",
    choices = component_list[[agencyBudget_input_values$agency]],
    selected = component_list[[agencyBudget_input_values$agency]][1]
  )
})

# update filtered data variable name
filtered_data_budget <- reactive({
  req(agencyBudget_input_values$agency)
  load_budget_data(
    agencyBudget_input_values$agency,
    data_dir = csv_dir
  )
})

filtered_input_budget <- reactive({
  component <- agencyBudget_input_values$component
  
  if (component == "DoS") {
    component <- "DOS_main"
  }
  
  column_to_plot <- paste0(component, "_budget")
  return(column_to_plot)
})

agencyBudget_year <- reactive({
  paste0("20", agencyBudget_input_values$fy)
})

renderPlotly({
  # temporary solution to missing budget column name (some missing underscore)
  if (!(filtered_input_budget() %in% colnames(filtered_data_budget()))) {
    plot_colname <- str_replace(filtered_input_budget(), "_", ".")
  } else {
    plot_colname <- filtered_input_budget()
  }
  
  if (plot_colname %in% colnames(filtered_data_budget())){
    plot_two_columns(
      filtered_data_budget(),
      plot_colname,
      agencyBudget_year()
    )
  } else {
    warning(str_glue("Column {plot_colname} not found in dataset."))
    return(NULL)
  }
})
```

Row {data-height=200}
-------------------------------------

###

```{r}
renderTable(filtered_data_budget())
```

Budgets vs. Backlogs
=====================================

Inputs {.sidebar}
-------------------------------------

```{r}
#### NOTE FOR THIS SECTION: CRCL isn't listed in original component list for DHS

# define variables for section
# update the IDs, change the list variable name, 
# then replace the variables with ctrl + f
BB_data_list <- list(
  agency_id = "BBAgency",
  component_id = "BBComponent",
  fy_id = "BBFY",
  column_id = "BB_column_id"
)

# column select UI. Update the variable name
BB_column_select_ui <- NULL

# provide custom ui for component selection
BB_component_select_ui <- selectInput(
  BB_data_list$component_id,
  "Component",
  choices = c("CBP", "PRIV", "USCIS", "ICE", "OIG", "CRCL"), 
  selected = "CBP"
)

# create UI. Update the variables
ui_function(
  section_agency_id = BB_data_list$agency_id, 
  section_component_id = BB_data_list$component_id, 
  section_fy_id = BB_data_list$fy_id, 
  custom_column_select_ui = BB_column_select_ui,
  agencies = c("DHS", "DOJ", "HHS", "DOS", "DOL"),
  component_select_ui = BB_component_select_ui
)
```

Row {data-height=300}
-------------------------------------

###

```{r}
# Reactive values list to hold the inputs
# Update the variable name and the variables inside observe({})
BB_input_values <- reactiveValues()

observe({
  BB_input_values$agency <- input[[BB_data_list$agency_id]]
  BB_input_values$component <- input[[BB_data_list$component_id]]
  BB_input_values$fy <- input[[BB_data_list$fy_id]]
  BB_input_values$data <- input[[BB_data_list$column_id]]
  BB_input_values$component_input_id <- BB_data_list$component_id
})

# Update filtered data variable name
filtered_data_budget_compare <- reactive({
  req(BB_input_values$agency)
  load_ratios_data(
    BB_input_values$agency,
    data_dir = csv_dir
  )
})

# update component selection
observe({
  req(BB_input_values$agency)
  updateSelectInput(
    session, BB_input_values$component_input_id, "Component",
    choices = component_list[[BB_input_values$agency]],
    selected = component_list[[BB_input_values$agency]][1]
  )
})

# column name
filtered_input_budget_compare <- reactive({
  component <- BB_input_values$component
  
  if (component == "DoS") {
    component <- "DOS_main"
  }
  
  column_to_plot <- paste0(component, "_ratio")
  return(column_to_plot)
})

BB_year <- reactive({
  paste0("20", BB_input_values$fy)
})

renderPlotly({
  plot_single_column_budget(
    filtered_data_budget_compare(),
    filtered_input_budget_compare(),
    BB_year()
  )
})
```


Row {data-height=300}
-------------------------------------
###

```{r}
# column name
filtered_input_budget_compare_backlog <- reactive({
  component <- BB_input_values$component
  
  if (component == "DoS") {
    component <- "DOS_main"
  }
  
  column_to_plot <- paste0(component, "_backlog")
  return(column_to_plot)
})

renderPlotly({
  plot_single_column_backlog(
    filtered_data_budget_compare(), 
    filtered_input_budget_compare_backlog(),
    BB_year()
  )
})
```

ABOUT
=====================================



Inputs {.sidebar}
-------------------------------------

<br>
<br>
<br>

The [Deportation Research Clinic's](https://deportation-research.buffett.northwestern.edu/) dashboard displays the data from the Freedom of Information Act (FOIA) Annual Reports released each year by federal agencies and their components. Access the Annual Reports [here](https://www.justice.gov/oip/reports-1). The dashboard's tabs reflect several of the categories of the Annual Reports. 

<br/>
For more information about the FOIA, see [foia.gov](https://www.foia.gov).

Row {data-height=300}
-------------------------------------
###
<br>
<br>

*ACKNOWLEDGEMENTS*

Created by [Kendall McKay](http://www.linkedin.com/in/kendallgmckay) for the [Deportation Research Clinic](https://deportation-research.buffett.northwestern.edu). Project manager: [Professor Jacqueline Stevens.](https://polisci.northwestern.edu/people/core-faculty/jacqueline-stevens.html) 
<br>
<br>
Project support provided by [Aaron Geller](https://faculty.wcas.northwestern.edu/aaron-geller/) and [Patrick Zacher](https://www.linkedin.com/in/patrick-zacher/) of Northwestern University's [IT Research Computing and Data Services (RCDS)](https://www.it.northwestern.edu/departments/it-services-support/research/).
<br>
<br>
Funding provided by the Northwestern University [Political Science Department](https://polisci.northwestern.edu/), the [Buffet Institute for Global Affairs](https://buffett.northwestern.edu/), and the [Institute for Policy Research](https://www.ipr.northwestern.edu).

<br>

*About*

Data on the FOIA Dashboard is from the United States’ Department of Justice’s [Annual FOIA Report Handbook.](https://www.justice.gov/media/1031511/dl?inline=) For more information, see the [DOJ's 2023 Training slides](https://www.justice.gov/d9/2023-10/refresher_training_for_annual_and_quarterly_foia_report_-_oct._2023.pdf) for the Annual Reports.

*DATA COLLECTION*

XML versions of the data were downloaded from individual agency websites, cleaned and processed through R, and uploaded and visualized to this dashboard. For more information, see the [Annual Reports.](https://www.justice.gov/oip/reports-1)

*ABOUT THE SECTIONS*

This dashboard includes data taken from the United States’ Freedom of Information Act (FOIA) Annual Reports compiled by federal agencies.

*PERSONNEL/COST*

*Full-Time:* The number of full-time FOIA employees. A “full-time FOIA employee” is a full-time employee who performs FOIA duties 100% of the time.

*Equivalent Full Time:* The number of equivalent full-time FOIA employees. This includes employees performing less than full-time FOIA duties that are either: (1) part-time employees who perform FOIA duties less than 100% of the time, or (2) full-time employees who perform FOIA duties less than 100% of the time. An “equivalent full-time FOIA employee” is created by adding together the percentages of time dedicated to FOIA duties by employees performing less than full-time FOIA work. Each time 100% is reached, the time expended is counted as one “equivalent full-time FOIA employee.” The number of such “equivalent” employees is reported in this category.

*Total Full Time Staff:* The combined total of full-time FOIA employees and equivalent full-time employees. Automatically populated for agencies using the 2009 Annual Report Tool to create their NIEM-XML. 

*Processing Expenditure:* The government data classified as 'processing costs' is labeled here as 'processing expenditures' because the amounts spent are not commensurate with the actual costs of complying with the FOIA statute and the government label is therefore misleading. The sum of all costs expended by the agency for processing FOIA requests at the initial request and administrative appeal levels. Includes salaries of FOIA personnel, overhead, and any other FOIA-related expenses. 

*Litigation Cost:* The sum of all costs expended by the agency in litigating FOIA requests. Includes the salaries of personnel involved in FOIA litigation, litigation overhead, attorney fees and costs, and any other FOIA litigation-related expenses.

*Total Cost:* The sum of the processing and litigation costs. Automatically populated for agencies using the 2009 Annual Report Tool to create their NIEM-XML.

*BACKLOG*

*Backlogged Requests:* The number of backlogged requests an agency has pending at the end of the fiscal year. A request is backlogged when it is pending beyond the statutory time period for a response. For requests, the statutory time period is twenty working days from receipt of the perfected request, see 5. U.S.C. § 552(a)(6)(A)(i), unless there are “unusual circumstances” in which case the time period may be extended for an additional ten working days, see id. § 552(a)(6)(B)(i). 

*EXPEDITED PROCESSING*

The FOIA statute requires agencies to “make a determination of whether to provide expedited processing” within ten days (5 U.S.C. § 552(a)(6)(E)(ii)(I). 

When calculating the response time for a request for expedited processing, agencies begin counting calendar days from the day the request for expedited processing is received until the day the agency provides notice to the requester of its determination to either grant or deny the request for expedited processing.

*Requests Granted:* The number of requests for expedited processing granted by the agency.

*Requests Denied:* The number of requests for expedited processing denied by the agency.

*Adjudication Median:* The median number of days taken by the agency to adjudicate requests for expedited processing. 

*Adjudication Average Days:* The average number of days taken by the agency to adjudicate requests for expedited processing.

*Within Ten Days:* The number of requests for expedited processing adjudicated within ten days, the time limit alloted for adjudication by 5 U.S.C. § 552(a)(6)(E)(ii)(I).

*PROCESSED REQUESTS*

*Pending FY Start:* The number of all perfected requests that remain open as of the start of the fiscal year. 

*Pending FY End:* The number of all perfected requests that remain open as of the end of the fiscal year.

*Requests Received:* The number of requests an agency receives in a fiscal year.

*Requests Processed:* The number of requests an agency processes in a fiscal year.

*PENDING REQUESTS*

*Request Type:* Requests have three processing tracks: simple; complex; and expedited. Agencies that have more than these three tracks allocate their various non-expedited tracks into either simple or complex, whichever best matches the the type of requests handled in those additional tracks.

*Pending Requests:* The number of all perfected requests which remained open as of the end of the relevant fiscal year.

*Median Days:* For all perfected requests which remained open as of the end of the relevant fiscal year, the median number of working days they had been pending.

*Average Days:* For all perfected requests which remained open as of the end of the relevant fiscal year, the average number of working days they had been pending.

*APPEAL DISPOSITION*

*Affirmed On Appeal:* The agency's administrative appellate authority affirms the agency's initial action on the request. This includes instances when the initial action is affirmed on modified grounds.

*Partially Affirmed On Appeal:* On appeal, portions of the agency’s initial action on the request are affirmed, but other aspects are either reversed or remanded.

*Reversed On Appeal:* On appeal, the agency’s initial determination is completely reversed and/or the request is completely remanded for further action.

*Appeal Closed - Other:* The agency neither affirms nor reverses/remands (either entirely or partially) the initial request determination, but rather closes the appeal for other reasons (e.g., the request was in litigation, the appeal was a duplicate appeal, the appeal was premature, etc.).

*Number of Appeals:* The number of appeals an agency receives in a given fiscal year.

*AGENCY BUDGETS*

*Total Budget Received:* The total dollars received per annum by each agency. 

*Total Budget Requested:* The total dollars requested per annum by each agency per congressional budget justifications.

*BUDGETS VS. BACKLOGS*

*Component FOIA Budget / Total Agency Budget:* This graph displays the selected component's FOIA budget (taken from the Personnel and Cost Section) divided by the larger agency's total budget (taken from the agency's congressional budget justification). The number displayed is a percentage.

*Component Backlog:* This graph displays the selected component's FOIA backlog, taken from the Backlog Section of the Annual Reports.

