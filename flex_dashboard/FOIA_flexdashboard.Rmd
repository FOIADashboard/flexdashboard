---
title: "FOIA dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    #source_code: embed
    theme:
      version: 4
      bootswatch: lux
---

```{r global}
# check if necessary packages exist
all_packages <- c("flexdashboard", "shiny", "knitr", "kableExtra",
                   "dplyr", "ggplot2", "plotly", "tidyr",
                   "stringr", "readr", "scales")
for (p in all_packages) {
  if (!(p %in% installed.packages()[,"Package"])) {
    install.packages(p)
  }
}

library(flexdashboard)
library(shiny)
library(knitr)
library(kableExtra)
library(dplyr)
library(ggplot2)
library(plotly)
library(tidyr)
library(ggplot2)
library(stringr)
library(readr)

# load functions used in script
source("functions.R")
source("ui_functions.R")

# global variables
csv_dir <- "data/csv"
agencies <- c("DHS", "EPA", "DOL", "DOJ", "DOS", "HHS")
agencies_budget <- c("DHS", "DOL", "DOJ", "HHS", "DOS")
component_list <- list(
  "DHS" = c("CBP", "PRIV", "USCIS", "ICE", "OIG", "CRCL"),
  "EPA" = c("HQ", "Region 1", "Region 2", "Region 3",
            "Region 4", "Region 5", "Region 6", "Region 7",
            "Region 8", "Region 9", "Region 10"),
  "DOL" = c("OSHA", "WHD", "OSEC", "OIG"),
  "DOJ" = c("EOIR", "OIG"),
  "HHS" = c("CDC", "ACF", "OIG"),
  "DOS" = c("OIG", "DoS")
)

# load foia data for all agencies
master_foia_data <- load_foia_data(agencies)
master_budget_data <- load_all_agencies_budget(
  c("DHS", "DOL", "DOJ", "HHS", "DOS")
)

# Possible sections for FOIA data
# The vector is formmated such that
# c("Name to display in dropdown" = "section_name", ...)
section_choices <- c(
    "Personnel and Cost" = "PersonnelAndCostSection",
    "Backlog" = "BacklogSection",
    "Expedited Processing" = "ExpeditedProcessingSection",
    "Processed Request" = "ProcessedRequestSection",
    "Pending Perfected Requests" = "PendingPerfectedRequestsSection",
    "Appeal Disposition" = "AppealDispositionSection")
selected_section_on_startup <- "PersonnelAndCostSection"

# define options for selected section
# Name in the list is the section name to access the data frame
# The vector (element of the list) is formatted such that
# c("Name to display in dropdown" = "column_name", ...)
variable_choice_list <- list(
  "PersonnelAndCostSection" = c(
    "Full Time" = "FullTimeEmployeeQuantity",
    "Equivalent Full Time" = "EquivalentFullTimeEmployeeQuantity",
    "Total Full Time Staff" = "TotalFullTimeStaffQuantity",
    "Processing Expenditure" = "ProcessingCostAmount",
    "Litigation Cost" = "LitigationCostAmount",
    "Total Cost" = "TotalCostAmount"),
  "BacklogSection" = c(
    "Backlogged Requests" = "BackloggedRequestQuantity"),
  "ExpeditedProcessingSection" = c(
    "Requests Granted" = "RequestGrantedQuantity",
    "Requests Denied" = "RequestDeniedQuantity",
    "Adjudication Median" = "AdjudicationMedianDaysValue",
    "Adjudication Avg. Days" = "AdjudicationAverageDaysValue",
    "Within Ten Days" = "AdjudicationWithinTenDaysQuantity"),
  "ProcessedRequestSection" = c(
    "Pending FY Start" = "ProcessingStatisticsPendingAtStartQuantity",
    "Pending FY End" = "ProcessingStatisticsPendingAtEndQuantity",
    "Requests Received" = "ProcessingStatisticsReceivedQuantity",
    "Requests Processed" = "ProcessingStatisticsProcessedQuantity"),
  "PendingPerfectedRequestsSection" = c(
    "Simple Pending Requests" = "SimplePendingRequestStatistics_PendingRequestQuantity",
    "Simple Median Days" = "SimplePendingRequestStatistics_PendingRequestMedianDaysValue",
    "Simple Average Days" = "SimplePendingRequestStatistics_PendingRequestAverageDaysValue",
    "Complex Pending Requests" = "ComplexPendingRequestStatistics_PendingRequestQuantity",
    "Complex Median Days" = "ComplexPendingRequestStatistics_PendingRequestMedianDaysValue",
    "Complex Average Days" = "ComplexPendingRequestStatistics_PendingRequestAverageDaysValue",
    "Expedited Pending Requests" = "ExpeditedPendingRequestStatistics_PendingRequestQuantity",
    "Expedited Median Days" = "ExpeditedPendingRequestStatistics_PendingRequestMedianDaysValue",
    "Expedited Average Days" = "ExpeditedPendingRequestStatistics_PendingRequestAverageDaysValue"),
  "AppealDispositionSection" = c(
    "Affirmed On Appeal" = "AppealDispositionAffirmedQuantity",
    "Partially Affirmed On Appeal" = "AppealDispositionPartialQuantity",
    "Reversed On Appeal" = "AppealDispositionReversedQuantity",
    "Appeal Closed - Other" = "AppealDispositionOtherQuantity",
    "Number of Appeals" = "AppealDispositionTotalQuantity")
)

# define manual title for each section
# Name in the list is the section name to access the data frame
# The vector (element of the list) is formatted such that
# c(column_name = "Manual Title", ...)
manual_title_list <- list(
  "PersonnelAndCostSection" = c(
    "FullTimeEmployeeQuantity" = "Full Time Employees",
    "EquivalentFullTimeEmployeeQuantity" = "Equivalent Full Time Employees",
    "TotalFullTimeStaffQuantity" = "Total Full Time Staff",
    "ProcessingCostAmount" = "Processing Expenditures",
    "LitigationCostAmount" = "Litigation Costs",
    "TotalCostAmount" = "Total Costs"
  ),
  "ExpeditedProcessingSection" = c(
    "RequestGrantedQuantity" = "Requests Granted",
    "RequestDeniedQuantity" = "Requests Denied",
    "AdjudicationMedianDaysValue" = "Median Adjudication (Days)",
    "AdjudicationAverageDaysValue" = "Average Adjudication (Days)",
    "AdjudicationWithinTenDaysQuantity" = "Requests Adjudicated Within Ten Days"
  ),
  "ProcessedRequestSection" = c(
    "ProcessingStatisticsPendingAtStartQuantity" = "Requests Pending at FY Start",
    "ProcessingStatisticsPendingAtEndQuantity" = "Requests Pending at FY End",
    "ProcessingStatisticsReceivedQuantity" = "Requests Received",
    "ProcessingStatisticsProcessedQuantity" = "Requests Processed"
  ),
  "PendingPerfectedRequestsSection" = c(
    "SimplePendingRequestStatistics_PendingRequestQuantity" = "Simple Pending Requests",
    "SimplePendingRequestStatistics_PendingRequestMedianDaysValue" = "Simple Median Days",
    "SimplePendingRequestStatistics_PendingRequestAverageDaysValue" = "Simple Average Days",
    "ComplexPendingRequestStatistics_PendingRequestQuantity" = "Complex Pending Requests",
    "ComplexPendingRequestStatistics_PendingRequestMedianDaysValue" = "Complex Median Days",
    "ComplexPendingRequestStatistics_PendingRequestAverageDaysValue" = "Complex Average Days",
    "ExpeditedPendingRequestStatistics_PendingRequestQuantity" = "Expedited Pending Requests",
    "ExpeditedPendingRequestStatistics_PendingRequestMedianDaysValue" = "Expedited Median Days",
    "ExpeditedPendingRequestStatistics_PendingRequestAverageDaysValue" = "Expedited Average Days"),
  "AppealDispositionSection" = c(
    "AppealDispositionAffirmedQuantity" = "Affirmed on Appeal",
    "AppealDispositionPartialQuantity" = "Partially Affirmed on Appeal",
    "AppealDispositionReversedQuantity" = "Reversed on Appeal",
    "AppealDispositionOtherQuantity" = "Appeals Closed for Other Reasons",
    "AppealDispositionTotalQuantity" = "Number of Appeals")
)

# UI and Server code template is available in tab_template.R file.
```

Section Explorer
=====================================

Inputs {.sidebar}
-----------------------------------

```{r}
# Section selection
radioButtons(
  "section_input",
  label="Section",
  choices=section_choices,
  selected=selected_section_on_startup,
)

# Agency selection
selectInput(
  "agency_input",
  "Agency", 
  choices =  agencies, 
  selected = "DHS")

# column select UI. Update the variable name
selectInput(
  "variable_select_input",
  "Data",
  choices = variable_choice_list[[selected_section_on_startup]],
  selected = variable_choice_list[[selected_section_on_startup]][1])

# component selection
checkboxGroupInput(
  "component_input",
  "Component",
  choices = c("CBP", "PRIV", "USCIS", "ICE", "OIG", "CRCL"), 
  selected = c("CBP", "PRIV"))

# Fiscal Year selection
# checkboxGroupInput(
#   "fy_input",
#   "FY", 
#   choices = c("10", "11", "12", "13", "14", "15", 
#               "16", "17", "18", "19", "20", "21", 
#               "22","23"), 
#   selected = c("10", "11", "12", "13", "14", "15", 
#               "16", "17", "18"))

sliderInput(
  "fy_input",
  "FY", 
  min = 10, 
  max = 23, 
  value = c(10, 23), 
  step = 1,
  sep = "")

HTML(
  "
  <div style=\"font-size: smaller; word-break: break-word; overflow-wrap: break-word;\">
    Jacqueline Stevens and Kendall McKay, FOIA Dashboard,
    <a href=\"https://deportationresearch.shinyapps.io/FOIAdashboard/\">https://deportationresearch.shinyapps.io/FOIAdashboard/</a>
    <br><br>
    Copyright:
    <a href=\"https://creativecommons.org/licenses/by-nc/4.0/\">CC BY-NC</a>
  </div>
  ")
```

Row
-------------------------------------

### Plot

```{r}
# capture section selection
section <- reactive({
  input$section_input
})
agency <- reactive({
  input$agency_input
})
component <- reactive({
  input$component_input
})
fy <- reactive({
  input$fy_input[1]:input$fy_input[2]
})
variable <- reactive({
  input$variable_select_input
})

# Update filtered data variable name
filtered_data <- reactive({
  req(agency())
  master_foia_data[[agency()]][[section()]]
})

# update data section selection based on selected section
observe({
  req(section())
  updateSelectInput(
    session, "variable_select_input", "Data",
    choices = variable_choice_list[[section()]],
    selected = variable_choice_list[[section()]][[1]]
  )
})

# update component selection based on selected agency
observe({
  req(agency())
  updateCheckboxGroupInput(
    session, "component_input", "Component",
    choices = component_list[[agency()]],
    selected = component_list[[agency()]][c(1,2)]
  )
})

# Maps the column name to the plot title
filtered_input_manual_title <- reactive({
  req(variable())
  req(section())
  if (section() %in% names(manual_title_list)) {
    manual_title_list[[section()]][[variable()]]
  } else {
    return(NULL)  # Return NULL if section not found
  }
})

renderPlotly({
  if ((variable() %in% colnames(filtered_data())) &
      (any(component() %in% filtered_data()$OrganizationAbbreviationText))) {
    plot_single_column(
      isolate(filtered_data()),
      variable(),
      component(),
      fy(),
      manual_title = filtered_input_manual_title()
    )
  }
})
```

Budgets
=====================================

Inputs {.sidebar}
-----------------------------------

<br/>

```{r}
# Agency selection
selectInput(
  "agency_input_b",
  label="Agency", 
  choices =  agencies_budget, 
  selected = "DHS")

# component selection
selectInput(
  "component_input_b",
  label="Component",
  choices = c("CBP", "PRIV", "USCIS", "ICE", "OIG", "CRCL"), 
  selected = c("CBP", "PRIV"))

sliderInput(
  "fy_input_b",
  "FY", 
  min = 10, 
  max = 23, 
  value = c(10, 23), 
  step = 1,
  sep = "")

HTML(
  "
  <div style=\"font-size: smaller; word-break: break-word; overflow-wrap: break-word;\">
    Jacqueline Stevens and Kendall McKay, FOIA Dashboard,
    <a href=\"https://deportationresearch.shinyapps.io/FOIAdashboard/\">https://deportationresearch.shinyapps.io/FOIAdashboard/</a>
    <br><br>
    Copyright:
    <a href=\"https://creativecommons.org/licenses/by-nc/4.0/\">CC BY-NC</a>
  </div>
  ")
```

Row {data-height=400}
-------------------------------------

### Budget Metrics

```{r, results='asis'}
agency_b <- reactive({
  input$agency_input_b
})
component_b <- reactive({
  input$component_input_b
})
fy_b <- reactive({
  input$fy_input_b[1]:input$fy_input_b[2]
})

# Update filtered data variable name
filtered_data_b <- reactive({
  req(agency_b())
  master_budget_data[[agency_b()]]
})

# update component selection based on selected agency
observe({
  req(agency_b())
  updateSelectInput(
    session, "component_input_b", "Component",
    choices = component_list[[agency_b()]],
    selected = component_list[[agency_b()]][1]
  )
})

# select column name
filtered_input_b <- reactive({
  component <- component_b()
  
  if (component == "DoS") {
    component <- "DOS_main"
  }
  
  column_to_plot <- paste0(component, "_budget")
  return(column_to_plot)
})

agencyBudget_year <- reactive({
  paste0("20", fy_b())
})

renderPlotly({
  # temporary solution to missing budget column name (some missing underscore)
  if (!(filtered_input_b() %in% colnames(filtered_data_b()))) {
    plot_colname <- str_replace(filtered_input_b(), "_", ".")
  } else {
    plot_colname <- filtered_input_b()
  }
  
  if (plot_colname %in% colnames(filtered_data_b())){
    plot_budget_metrics(
      filtered_data_b(),
      plot_colname,
      agencyBudget_year()
    )
  } else {
    warning(str_glue("Column {plot_colname} not found in dataset."))
    return(NULL)
  }
})
```

### Budgets vs. Backlogs

```{r}
filtered_input_b_ratio <- reactive({
  component <- component_b()
  
  if (component == "DoS") {
    component <- "DOS_main"
  }
  
  column_to_plot <- paste0(component, "_ratio")
  return(column_to_plot)
})

filtered_input_b_backlog <- reactive({
  component <- component_b()
  
  if (component == "DoS") {
    component <- "DOS_main"
  }
  
  column_to_plot <- paste0(component, "_backlog")
  return(column_to_plot)
})

renderPlotly({
  
  if (filtered_input_b_ratio() %in% colnames(filtered_data_b())){
    p1 <- plot_budget_ratio(
      filtered_data_b(),
      filtered_input_b_ratio(),
      agencyBudget_year())
    if (is.null(p1)) {
      p1 <- (ggplot() + geom_blank() + 
        ggtitle("No data available for this agency/component.")) %>%
        ggplotly()
    }
  } else {
    warning(str_glue("Column {filtered_input_b_ratio()} not found in dataset."))
    p1 <- (ggplot() + geom_blank() + 
      ggtitle("No data available for this agency/component.")) %>%
      ggplotly()
  }
  
  if (filtered_input_b_backlog() %in% colnames(filtered_data_b())){
    p2 <- plot_backlog(
      filtered_data_b(),
      filtered_input_b_backlog(),
      agencyBudget_year())
    if (is.null(p2)) {
      p2 <- (ggplot() + geom_blank() + 
        ggtitle("No data available for this agency/component.")) %>%
        ggplotly()
    }
  } else {
    warning(str_glue("Column {filtered_input_b_backlog()} not found in dataset."))
    p2 <- (ggplot() + geom_blank() + 
      ggtitle("No data available for this agency/component.")) %>% 
      ggplotly()
  }
  
  subplot(p1, p2, nrows = 2, shareX = TRUE, shareY = FALSE, titleY = TRUE) %>%
    layout(title = "Budgets Ratio vs. Backlogged Requests")
})
```


Row {data-height=200}
-------------------------------------

###

```{r}
renderTable(filtered_data_b())
```

ABOUT
=====================================

Inputs {.sidebar}
-------------------------------------

<br>

The [Deportation Research Clinic's](https://deportation-research.buffett.northwestern.edu/) dashboard displays the data from the Freedom of Information Act (FOIA) Annual Reports released each year by federal agencies and their components. Access the Annual Reports [here](https://www.justice.gov/oip/reports-1). The dashboard's tabs reflect several of the categories of the Annual Reports. 

<br/>
For more information about the FOIA, see [foia.gov](https://www.foia.gov).

Row {data-height=300}
-------------------------------------

###

*USAGE GUIDE*

The dashboard displays the data from the Freedom of Information Act (FOIA) Annual Reports released each year by federal agencies and their components. 
The sources for the department and component annual budgets data are available <a href="https://www.justice.gov/oip/reports-1">here</a>.

Please select sections, data type, component agency(s), and fiscal year(s) using the sidebar.

For more information about the FOIA, see <a href="https://www.foia.gov">foia.gov</a>.

Created by <a href="https://deportation-research.buffett.northwestern.edu/people/">Kendall McKay</a> for the <a href="https://deportation-research.buffett.northwestern.edu">Deportation Research Clinic</a>.

Project support provided by <a href="https://faculty.wcas.northwestern.edu/aaron-geller/">Aaron Geller</a> and <a href="https://www.linkedin.com/in/patrick-zacher/">Patrick Zacher</a> of Northwestern University's <a href="https://www.it.northwestern.edu/departments/it-services-support/research/">IT Research Computing and Data Services (RCDS)</a>.

Funding provided by the Northwestern University <a href="https://www.ipr.northwestern.edu">Institute for Policy Research (IPR)</a>.

*ACKNOWLEDGEMENTS*

Created by [Kendall McKay](http://www.linkedin.com/in/kendallgmckay) for the [Deportation Research Clinic](https://deportation-research.buffett.northwestern.edu). Project manager: [Professor Jacqueline Stevens.](https://polisci.northwestern.edu/people/core-faculty/jacqueline-stevens.html) 
<br>
<br>
Project support provided by [Aaron Geller](https://faculty.wcas.northwestern.edu/aaron-geller/) and [Patrick Zacher](https://www.linkedin.com/in/patrick-zacher/) of Northwestern University's [IT Research Computing and Data Services (RCDS)](https://www.it.northwestern.edu/departments/it-services-support/research/).
<br>
<br>
Funding provided by the Northwestern University [Political Science Department](https://polisci.northwestern.edu/), the [Buffet Institute for Global Affairs](https://buffett.northwestern.edu/), and the [Institute for Policy Research](https://www.ipr.northwestern.edu).

<br>

*About*

Data on the FOIA Dashboard is from the United States’ Department of Justice’s [Annual FOIA Report Handbook.](https://www.justice.gov/media/1031511/dl?inline=) For more information, see the [DOJ's 2023 Training slides](https://www.justice.gov/d9/2023-10/refresher_training_for_annual_and_quarterly_foia_report_-_oct._2023.pdf) for the Annual Reports.

*DATA COLLECTION*

XML versions of the data were downloaded from individual agency websites, cleaned and processed through R, and uploaded and visualized to this dashboard. For more information, see the [Annual Reports.](https://www.justice.gov/oip/reports-1)

*ABOUT THE SECTIONS*

This dashboard includes data taken from the United States’ Freedom of Information Act (FOIA) Annual Reports compiled by federal agencies.

*PERSONNEL/COST*

*Full-Time:* The number of full-time FOIA employees. A “full-time FOIA employee” is a full-time employee who performs FOIA duties 100% of the time.

*Equivalent Full Time:* The number of equivalent full-time FOIA employees. This includes employees performing less than full-time FOIA duties that are either: (1) part-time employees who perform FOIA duties less than 100% of the time, or (2) full-time employees who perform FOIA duties less than 100% of the time. An “equivalent full-time FOIA employee” is created by adding together the percentages of time dedicated to FOIA duties by employees performing less than full-time FOIA work. Each time 100% is reached, the time expended is counted as one “equivalent full-time FOIA employee.” The number of such “equivalent” employees is reported in this category.

*Total Full Time Staff:* The combined total of full-time FOIA employees and equivalent full-time employees. Automatically populated for agencies using the 2009 Annual Report Tool to create their NIEM-XML. 

*Processing Expenditure:* The government data classified as 'processing costs' is labeled here as 'processing expenditures' because the amounts spent are not commensurate with the actual costs of complying with the FOIA statute and the government label is therefore misleading. The sum of all costs expended by the agency for processing FOIA requests at the initial request and administrative appeal levels. Includes salaries of FOIA personnel, overhead, and any other FOIA-related expenses. 

*Litigation Cost:* The sum of all costs expended by the agency in litigating FOIA requests. Includes the salaries of personnel involved in FOIA litigation, litigation overhead, attorney fees and costs, and any other FOIA litigation-related expenses.

*Total Cost:* The sum of the processing and litigation costs. Automatically populated for agencies using the 2009 Annual Report Tool to create their NIEM-XML.

*BACKLOG*

*Backlogged Requests:* The number of backlogged requests an agency has pending at the end of the fiscal year. A request is backlogged when it is pending beyond the statutory time period for a response. For requests, the statutory time period is twenty working days from receipt of the perfected request, see 5. U.S.C. § 552(a)(6)(A)(i), unless there are “unusual circumstances” in which case the time period may be extended for an additional ten working days, see id. § 552(a)(6)(B)(i). 

*EXPEDITED PROCESSING*

The FOIA statute requires agencies to “make a determination of whether to provide expedited processing” within ten days (5 U.S.C. § 552(a)(6)(E)(ii)(I). 

When calculating the response time for a request for expedited processing, agencies begin counting calendar days from the day the request for expedited processing is received until the day the agency provides notice to the requester of its determination to either grant or deny the request for expedited processing.

*Requests Granted:* The number of requests for expedited processing granted by the agency.

*Requests Denied:* The number of requests for expedited processing denied by the agency.

*Adjudication Median:* The median number of days taken by the agency to adjudicate requests for expedited processing. 

*Adjudication Average Days:* The average number of days taken by the agency to adjudicate requests for expedited processing.

*Within Ten Days:* The number of requests for expedited processing adjudicated within ten days, the time limit alloted for adjudication by 5 U.S.C. § 552(a)(6)(E)(ii)(I).

*PROCESSED REQUESTS*

*Pending FY Start:* The number of all perfected requests that remain open as of the start of the fiscal year. 

*Pending FY End:* The number of all perfected requests that remain open as of the end of the fiscal year.

*Requests Received:* The number of requests an agency receives in a fiscal year.

*Requests Processed:* The number of requests an agency processes in a fiscal year.

*PENDING REQUESTS*

*Request Type:* Requests have three processing tracks: simple; complex; and expedited. Agencies that have more than these three tracks allocate their various non-expedited tracks into either simple or complex, whichever best matches the the type of requests handled in those additional tracks.

*Pending Requests:* The number of all perfected requests which remained open as of the end of the relevant fiscal year.

*Median Days:* For all perfected requests which remained open as of the end of the relevant fiscal year, the median number of working days they had been pending.

*Average Days:* For all perfected requests which remained open as of the end of the relevant fiscal year, the average number of working days they had been pending.

*APPEAL DISPOSITION*

*Affirmed On Appeal:* The agency's administrative appellate authority affirms the agency's initial action on the request. This includes instances when the initial action is affirmed on modified grounds.

*Partially Affirmed On Appeal:* On appeal, portions of the agency’s initial action on the request are affirmed, but other aspects are either reversed or remanded.

*Reversed On Appeal:* On appeal, the agency’s initial determination is completely reversed and/or the request is completely remanded for further action.

*Appeal Closed - Other:* The agency neither affirms nor reverses/remands (either entirely or partially) the initial request determination, but rather closes the appeal for other reasons (e.g., the request was in litigation, the appeal was a duplicate appeal, the appeal was premature, etc.).

*Number of Appeals:* The number of appeals an agency receives in a given fiscal year.

*AGENCY BUDGETS*

*Total Budget Received:* The total dollars received per annum by each agency. 

*Total Budget Requested:* The total dollars requested per annum by each agency per congressional budget justifications.

*BUDGETS VS. BACKLOGS*

*Component FOIA Budget / Total Agency Budget:* This graph displays the selected component's FOIA budget (taken from the Personnel and Cost Section) divided by the larger agency's total budget (taken from the agency's congressional budget justification). The number displayed is a percentage.

*Component Backlog:* This graph displays the selected component's FOIA backlog, taken from the Backlog Section of the Annual Reports.

